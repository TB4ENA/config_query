name: Commit action
on:
  push:
    branches:
      - '**'
  workflow_dispatch:
  delete:

jobs:
  CI:
    environment: awx
    env:
      TOWER_USERNAME: ${{ secrets.AWX_USER }}
      TOWER_PASSWORD: ${{ secrets.AWX_TOKEN }}
      TOWER_VERIFY_SSL: false

    runs-on: awxdemo
    concurrency: ${{ github.event.ref }}
    env:
      ANSIBLE_HOST_KEY_CHECKING: false
      GIT_USERNAME: ${{ secrets.GH_USER }}
      GIT_PASSWORD: ${{ secrets.GH_TOKEN }}
    steps:
      - uses: actions/checkout@v3

      - name: Install pip3
        run: pip3 install -r .github/requirements.txt --force

      - name: Install collections
        if: github.ref_type == 'branch'
        run: ansible-galaxy collection install -r .github/collections.yml --force

      - name: Ansible lint
        run: ansible-lint playbook.yml --exclude vars/ --exclude defaults/ -c .config/ansible-lint.yml

      - name: Run integration
        if: github.ref_type == 'branch'
        run: ansible-playbook -vvv .ci/awx.yml -e git_ref=${{ github.event.ref }}